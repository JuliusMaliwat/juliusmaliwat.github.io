---
// Project landing page: rich, single-project narrative.
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Nav from "../../components/Nav.astro";
import Footer from "../../components/Footer.astro";
import { TECH_ICON_MAP } from "../../consts";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  const published = projects.filter((project) => !project.data.draft);
  return published.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await project.render();
const profileEntry = (await getCollection("profile"))[0];
const profile = profileEntry?.data;
const isWhyAmIHere = project.slug === "why-am-i-here-extension";
const heroMedia = project.data.media?.[0];
const galleryMedia = project.data.media?.slice(1) ?? [];
const primaryLink = project.data.links?.[0];
const githubLink =
  project.data.links?.find((item) => item.label.toLowerCase().includes("github")) ??
  project.data.links?.[1];
---

<BaseLayout title={project.data.title} description={project.data.summary}>
  <main class={isWhyAmIHere ? "page project-page project-page--extension" : "page project-page"}>
    <Nav variant="brand-only" />
    {isWhyAmIHere ? (
      <>
        <section class="extension-hero" data-reveal>
          <div class="extension-hero-copy">
            <div class="eyebrow">Chrome extension</div>
            <div class="extension-hero-title">
              <span class="extension-logo-wrap" aria-hidden="true">
                <img
                  class="extension-logo"
                  src="/projects/why-am-i-here/logo-dark.svg"
                  alt=""
                  loading="lazy"
                />
              </span>
              <h1 class="hero-title">{project.data.title}</h1>
            </div>
            <p class="lead">{project.data.summary}</p>
            <p class="muted extension-subcopy">{project.data.solution}</p>
            {project.data.tech?.length && (
              <div class="tech-pills extension-tech">
                {project.data.tech.map((tech) => (
                  <span class="pill tech-pill">
                    {TECH_ICON_MAP[tech] && (
                      <img class="tech-pill-icon" src={TECH_ICON_MAP[tech]} alt={`${tech} icon`} loading="lazy" />
                    )}
                    <span>{tech}</span>
                  </span>
                ))}
              </div>
            )}
            <div class="extension-cta">
              {primaryLink && (
                <a class="button" href={primaryLink.url} target="_blank" rel="noreferrer">
                  {primaryLink.label}
                </a>
              )}
              {githubLink && (
                <a class="button ghost" href={githubLink.url} target="_blank" rel="noreferrer">
                  View source
                </a>
              )}
            </div>
          </div>
          {heroMedia && (
            <div class="extension-hero-media">
              <img src={heroMedia.src} alt={heroMedia.alt} loading="lazy" />
            </div>
          )}
        </section>

        {project.data.highlights?.length && (
          <section class="section-block" data-reveal>
            <h2>Why it works</h2>
            <div class="extension-highlights">
              {project.data.highlights.map((item) => (
                <article class="extension-highlight-item">
                  <p>{item}</p>
                </article>
              ))}
            </div>
          </section>
        )}

        <section class="section-block" data-reveal>
          <h2>How it works</h2>
          <div class="extension-steps">
            <p><strong>1.</strong> Select the distracting domains you want to guard.</p>
            <p><strong>2.</strong> When a domain opens, the extension asks why you are there.</p>
            <p><strong>3.</strong> Set an intention and a timer before continuing.</p>
            <p><strong>4.</strong> When time expires, the prompt returns so the session stays intentional.</p>
          </div>
        </section>

        {galleryMedia.length > 0 && (
          <section class="section-block" data-reveal>
            <h2>Product screens</h2>
            <div class="extension-gallery" data-stagger>
              {galleryMedia.map((item) => (
                <figure class="extension-gallery-item" data-reveal>
                  <img src={item.src} alt={item.alt} loading="lazy" />
                </figure>
              ))}
            </div>
          </section>
        )}

        <section class="section-block" data-reveal>
          <h2>Details</h2>
          <Content />
        </section>
      </>
    ) : (
      <>
        <section class="section-heading" data-reveal>
          <div class="eyebrow">{project.data.type}</div>
          <h1 class="hero-title">{project.data.title}</h1>
          <p class="lead">{project.data.summary}</p>
          {project.data.tech?.length && (
            <div class="tech-pills">
              {project.data.tech.map((tech) => (
                <span class="pill tech-pill">
                  {TECH_ICON_MAP[tech] && (
                    <img class="tech-pill-icon" src={TECH_ICON_MAP[tech]} alt={`${tech} icon`} loading="lazy" />
                  )}
                  <span>{tech}</span>
                </span>
              ))}
            </div>
          )}
          {project.data.links?.length && (
            <div class="project-links">
              {project.data.links.map((link) => (
                <a href={link.url} target="_blank" rel="noreferrer" class="inline-link">
                  {link.label}
                </a>
              ))}
            </div>
          )}
        </section>

        <section class="section-block" data-reveal>
          <h2>Overview</h2>
          {project.data.problem && (
            <p><strong>Problem:</strong> {project.data.problem}</p>
          )}
          {project.data.solution && (
            <p><strong>Solution:</strong> {project.data.solution}</p>
          )}
          {project.data.highlights?.length && (
            <ul>
              {project.data.highlights.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          )}
        </section>

        <section class="section-block" data-reveal>
          <h2>Details</h2>
          <Content />
        </section>
      </>
    )}

    <Footer email={profile?.email} location={profile?.location} links={profile?.links} />
  </main>
</BaseLayout>

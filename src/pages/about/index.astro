---
// About Me page: combined CV view (experience + education) with accordions.
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Nav from "../../components/Nav.astro";
import Footer from "../../components/Footer.astro";

const profileEntry = (await getCollection("profile"))[0];
const profile = profileEntry?.data;
const experience = await getCollection("experience");
const education = await getCollection("education");
const certifications = await getCollection("certifications");
const interests = await getCollection("interests");

// Sort entries newest-first using startDate (MM/YYYY or YYYY).
const parseStartDate = (value = "") => {
  const parts = value.split("/");
  if (parts.length === 2) {
    const [month, year] = parts;
    return new Date(Number(year), Number(month) - 1, 1).getTime();
  }
  const year = Number(value);
  return Number.isFinite(year) ? new Date(year, 0, 1).getTime() : 0;
};

const sortByStartDesc = (a, b) => parseStartDate(b.data.startDate) - parseStartDate(a.data.startDate);
const experienceSorted = [...experience].sort(sortByStartDesc);
const educationSorted = [...education].sort(sortByStartDesc);
const certificationsSorted = [...certifications].sort(
  (a, b) => Date.parse(b.data.date) - Date.parse(a.data.date)
);
---

<BaseLayout title="About Me" description={profile?.bioShort}>
  <main>
    <Nav />
    <h1>About Me</h1>
    <section>
      <h2>Experience</h2>
      <div class="timeline">
        {experienceSorted.map((role) => (
          <details class="accordion-item">
            <summary>
              <span class="timeline-date muted">
                {role.data.startDate} — {role.data.endDate ?? "Present"}
              </span>
              <div class="timeline-content">
                <strong>{role.data.role}</strong>
                <div class="muted">
                  {role.data.company} · {role.data.location}
                </div>
              </div>
            </summary>
            <div class="accordion-body">
              <p>{role.data.summary}</p>
              {role.data.highlights?.length && (
                <ul>
                  {role.data.highlights.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              )}
              {role.data.tech?.length && (
                <div class="nav-links">
                  {role.data.tech.map((tech) => (
                    <span class="pill">{tech}</span>
                  ))}
                </div>
              )}
            </div>
          </details>
        ))}
      </div>
    </section>

    <section>
      <h2>Education</h2>
      <div class="timeline">
        {educationSorted.map((item) => (
          <details class="accordion-item">
            <summary>
              <span class="timeline-date muted">
                {item.data.startDate} — {item.data.endDate}
              </span>
              <div class="timeline-content">
                <strong>
                  {item.data.degree}
                  {item.data.grade && <span class="grade"> · {item.data.grade}</span>}
                </strong>
                <div class="muted">
                  {item.data.institution} · {item.data.location}
                </div>
              </div>
            </summary>
            <div class="accordion-body">
              {item.data.summary && <p>{item.data.summary}</p>}
              {item.data.thesis && <p><strong>Thesis:</strong> {item.data.thesis}</p>}
              {item.data.courses?.length && (
                <>
                  <div class="eyebrow">Relevant coursework</div>
                  <ul class="course-list">
                    {item.data.courses.map((course) => (
                      <li>{course}</li>
                    ))}
                  </ul>
                </>
              )}
              {item.data.projects?.length && (
                <ul>
                  {item.data.projects.map((project) => (
                    <li>{project}</li>
                  ))}
                </ul>
              )}
              {item.data.highlights?.length && (
                <ul>
                  {item.data.highlights.map((highlight) => (
                    <li>{highlight}</li>
                  ))}
                </ul>
              )}
            </div>
          </details>
        ))}
      </div>
    </section>

    <section>
      <h2>Certifications</h2>
      <div class="cert-list">
        {certificationsSorted.map((cert) => (
          <div class="cert-item">
            <div>
              <strong>{cert.data.title}</strong>
              <div class="muted">{cert.data.issuer}</div>
            </div>
            <div class="cert-meta">
              <span class="muted">{cert.data.date}</span>
              <a class="cert-link" href={cert.data.credentialUrl} target="_blank" rel="noreferrer">
                View credential
              </a>
            </div>
          </div>
        ))}
      </div>
    </section>

    <section>
      <h2>Hobbies & Interests</h2>
      <div class="interests-grid">
        {interests.map((interest) => (
          <div class="interest-item">
            {interest.data.icon && <span class="interest-icon">{interest.data.icon}</span>}
            <span>{interest.data.label}</span>
          </div>
        ))}
      </div>
    </section>

    <Footer email={profile?.email} location={profile?.location} links={profile?.links} />
  </main>
</BaseLayout>

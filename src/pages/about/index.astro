---
// About Me page: combined CV view (experience + education) with accordions.
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Nav from "../../components/Nav.astro";
import Footer from "../../components/Footer.astro";

const profileEntry = (await getCollection("profile"))[0];
const profile = profileEntry?.data;
const experience = await getCollection("experience");
const education = await getCollection("education");
const certifications = await getCollection("certifications");
const interests = await getCollection("interests");
const skills = await getCollection("skills");

// Sort entries newest-first using startDate (MM/YYYY or YYYY).
const parseStartDate = (value = "") => {
  const parts = value.split("/");
  if (parts.length === 2) {
    const [month, year] = parts;
    return new Date(Number(year), Number(month) - 1, 1).getTime();
  }
  const year = Number(value);
  return Number.isFinite(year) ? new Date(year, 0, 1).getTime() : 0;
};

const sortByStartDesc = (a, b) => parseStartDate(b.data.startDate) - parseStartDate(a.data.startDate);
const experienceSorted = [...experience].sort(sortByStartDesc);
const educationSorted = [...education].sort(sortByStartDesc);
const certificationsSorted = [...certifications].sort(
  (a, b) => Date.parse(b.data.date) - Date.parse(a.data.date)
);

const skillCategoryOrder = [
  "Programming & Development",
  "Data Engineering & Cloud",
  "Data Science, AI & Analytics",
];

const groupedSkills = skillCategoryOrder
  .map((category) => ({
    category,
    items: skills
      .filter((entry) => entry.data.category === category)
      .sort(
        (a, b) =>
          (a.data.order ?? Number.MAX_SAFE_INTEGER) -
            (b.data.order ?? Number.MAX_SAFE_INTEGER) || a.data.name.localeCompare(b.data.name)
      ),
  }))
  .filter((group) => group.items.length > 0);

const techIconMap = {
  Python: "/skills/python.svg",
  SQL: "/skills/sql.icon.svg",
  JavaScript: "/skills/javascript.svg",
  R: "/skills/R.svg",
  Git: "/skills/git.svg",
  Spark: "/skills/spark.svg",
  AWS: "/skills/aws.svg",
  Databricks: "/skills/databricks.svg",
  TensorFlow: "/skills/tensorflow.svg",
  PyTorch: "/skills/pytorch.svg",
  "scikit-learn": "/skills/scikit-learn.svg",
  pandas: "/skills/Pandas.svg",
  Tableau: "/skills/tableau.svg",
  React: "/skills/react.svg",
  Terraform: "/skills/terraform.svg",
} as const;

const githubLogo = "/logos/github.svg";
---

<BaseLayout title="About Me" description={profile?.bioShort}>
  <main>
    <Nav />
    <h1>About Me</h1>

    <section>
      <h2>Experience</h2>
      <div class="timeline">
        {experienceSorted.map((role) => (
          <details class="accordion-item">
            <summary>
              <span class="timeline-date muted">
                {role.data.startDate} - {role.data.endDate ?? "Present"}
              </span>
              <div class="timeline-content">
                <strong>{role.data.role}</strong>
                {role.data.companyUrl ? (
                  <a
                    class="company-link muted"
                    href={role.data.companyUrl}
                    target="_blank"
                    rel="noreferrer"
                  >
                    {role.data.companyLogo && (
                      <img
                        class="company-logo"
                        src={role.data.companyLogo}
                        alt={`${role.data.company} logo`}
                        loading="lazy"
                      />
                    )}
                    <span>
                      {role.data.company}
                      {role.data.location ? ` | ${role.data.location}` : ""}
                    </span>
                  </a>
                ) : (
                  <div class="muted">
                    {role.data.company}
                    {role.data.location ? ` | ${role.data.location}` : ""}
                  </div>
                )}
              </div>
            </summary>
            <div class="accordion-body">
              <p>{role.data.summary}</p>
              {role.data.highlights?.length && (
                <ul>
                  {role.data.highlights.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              )}
              {role.data.tech?.length && (
                <div class="nav-links">
                  {role.data.tech.map((tech) => (
                    <span class="pill tech-pill">
                      {techIconMap[tech as keyof typeof techIconMap] && (
                        <img
                          class="tech-pill-icon"
                          src={techIconMap[tech as keyof typeof techIconMap]}
                          alt={`${tech} icon`}
                          loading="lazy"
                        />
                      )}
                      <span>{tech}</span>
                    </span>
                  ))}
                </div>
              )}
            </div>
          </details>
        ))}
      </div>
    </section>

    <section>
      <h2>Education</h2>
      <div class="timeline">
        {educationSorted.map((item) => (
          <details class="accordion-item">
            <summary>
              <span class="timeline-date muted">
                {item.data.startDate} - {item.data.endDate}
              </span>
              <div class="timeline-content">
                <strong>
                  {item.data.degreeUrl ? (
                    <a class="degree-link" href={item.data.degreeUrl} target="_blank" rel="noreferrer">
                      {item.data.degree}
                    </a>
                  ) : (
                    item.data.degree
                  )}
                  {item.data.grade && <span class="grade"> | {item.data.grade}</span>}
                </strong>
                <div class="institution-line muted">
                  {item.data.institutionLogo && (
                    <img
                      class="institution-logo"
                      src={item.data.institutionLogo}
                      alt={`${item.data.institution} logo`}
                      loading="lazy"
                    />
                  )}
                  <span>
                    {item.data.institution}
                    {item.data.location ? ` | ${item.data.location}` : ""}
                  </span>
                </div>
              </div>
            </summary>
            <div class="accordion-body">
              {item.data.summary && <p>{item.data.summary}</p>}
              {item.data.thesis && (
                <p>
                  <strong>Thesis:</strong>{" "}
                  {item.data.thesisUrl ? (
                    <a class="inline-link repo-link" href={item.data.thesisUrl} target="_blank" rel="noreferrer">
                      <img class="repo-link-icon" src={githubLogo} alt="GitHub" loading="lazy" />
                      <span>{item.data.thesis}</span>
                    </a>
                  ) : (
                    item.data.thesis
                  )}
                </p>
              )}
              {item.data.courses?.length && (
                <>
                  <div class="eyebrow">Relevant coursework</div>
                  <ul class="course-list">
                    {item.data.courses.map((course) => (
                      <li>{course}</li>
                    ))}
                  </ul>
                </>
              )}
              {item.data.universityProjects?.length && (
                <>
                  <div class="eyebrow">University projects</div>
                  <div class="uni-project-grid">
                    {item.data.universityProjects.map((project) => (
                      <a
                        class="uni-project-card"
                        href={project.url}
                        target="_blank"
                        rel="noreferrer"
                      >
                        <strong>{project.title}</strong>
                        {project.course && <span class="muted">{project.course}</span>}
                        <span class="uni-project-link">
                          <img class="repo-link-icon" src={githubLogo} alt="GitHub" loading="lazy" />
                          <span>View on GitHub</span>
                        </span>
                      </a>
                    ))}
                  </div>
                </>
              )}
              {item.data.highlights?.length && (
                <ul>
                  {item.data.highlights.map((highlight) => (
                    <li>{highlight}</li>
                  ))}
                </ul>
              )}
            </div>
          </details>
        ))}
      </div>
    </section>

    <section>
      <h2>Certifications</h2>
      <div class="cert-list">
        {certificationsSorted.map((cert) => (
          <div class="cert-item">
            <div class="cert-main">
              {cert.data.badgeImage && (
                <img
                  class="cert-badge"
                  src={cert.data.badgeImage}
                  alt={`${cert.data.title} badge`}
                  loading="lazy"
                />
              )}
              <div>
                <strong>{cert.data.title}</strong>
                <div class="muted">{cert.data.issuer}</div>
              </div>
            </div>
            <div class="cert-meta">
              <span class="muted">{cert.data.date}</span>
              <a class="cert-link" href={cert.data.credentialUrl} target="_blank" rel="noreferrer">
                View credential
              </a>
            </div>
          </div>
        ))}
      </div>
    </section>

    <section>
      <h2>Skills</h2>
      <div class="skills-groups">
        {groupedSkills.map((group) => (
          <div class="skills-group">
            <div class="eyebrow">{group.category}</div>
            <div class="skills-grid">
              {group.items.map((skill) => (
                <span
                  class="skill-icon-only"
                  aria-label={skill.data.name}
                  data-skill={skill.data.name}
                  title={skill.data.name}
                  tabindex="0"
                >
                  <img
                    class="skill-icon"
                    src={skill.data.icon}
                    alt={`${skill.data.name} icon`}
                    loading="lazy"
                  />
                </span>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>

    <section>
      <h2>Hobbies & Interests</h2>
      <div class="interests-grid">
        {interests.map((interest) => (
          <div class="interest-item">
            {interest.data.icon && <span class="interest-icon">{interest.data.icon}</span>}
            <span>{interest.data.label}</span>
          </div>
        ))}
      </div>
    </section>

    <Footer email={profile?.email} location={profile?.location} links={profile?.links} />
  </main>
</BaseLayout>
